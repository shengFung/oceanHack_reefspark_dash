<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../static/assets/img/logospark.png">
  <link rel="icon" type="image/png" href="../static/assets/img/logospark.png">
  <title>Simek - reefSpark</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- CSS Files -->
  <link id="pagestyle" href="../static/assets/css/soft-ui-dashboard.css?v=1.1.0" rel="stylesheet" />
</head>

<body class="g-sidenav-show  bg-gray-100">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 " id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href="/">
        <img src="../static/assets/img/logospark.png" class="navbar-brand-img h-100" alt="main_logo">
        <span class="ms-1 font-weight-bold">reefSpark</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link  " href="/">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg">
                <title>archive</title>
                <path d="M5,10 L40,10 L40,30 L5,30 Z M10,15 L35,15 M10,20 L35,20" fill="#000000"/>
              </svg>
            </div>
            <span class="nav-link-text ms-1">Historical Insights</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link  " href="/litters">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg">
                <title>litter</title>
                <rect x="8" y="18" width="6" height="12" fill="#000000"/>
                <rect x="20" y="14" width="6" height="16" fill="#000000"/>
                <rect x="32" y="10" width="6" height="20" fill="#000000"/>
              </svg>
            </div>
            <span class="nav-link-text ms-1">Litters Information</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/simek">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <img src="../static/media/simekIcon.png" alt="Simek" style="width: 32px; height: 32px; object-fit: contain;">
            </div>
            <span class="nav-link-text ms-1">Simek</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link  " href="/live-monitor">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
             <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg">
              <title>satellite</title>
              <circle cx="22.5" cy="20" r="10" stroke="#000000" stroke-width="2" fill="none"/>
              <line x1="10" y1="10" x2="35" y2="30" stroke="#000000" stroke-width="2"/>
            </svg>
            </div>
            <span class="nav-link-text ms-1">Live Monitor</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link  " href="./pages/billing.html">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg">
                <title>forecast</title>
                <polyline points="5,30 15,20 25,25 35,15 45,20" fill="none" stroke="#000000" stroke-width="2"/>
              </svg>
            </div>
            <span class="nav-link-text ms-1">Forecast & Prediction</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="/">Dashboard</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Simek</li>
          </ol>
          <h6 class="font-weight-bolder mb-0">Simek Chat</h6>
        </nav>
      </div>
    </nav>
    <!-- End Navbar -->

    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header pb-0">
              <h6>Chat with Simek</h6>
              <p class="text-sm mb-0">Ask questions about reef health, environmental data, trends, and predictions</p>
            </div>
            <div class="card-body">
              <!-- Chat Container -->
              <div id="chat-container" style="height: 500px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 0.5rem; padding: 1rem; background-color: #f8f9fa; margin-bottom: 1rem;">
                <!-- Welcome Message -->
                <div class="chat-message assistant-message mb-3">
                  <div class="d-flex align-items-start">
                    <img src="/static/media/AiPFP.png" alt="Simek" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 0.5rem;">
                    <div class="message-content" style="background: white; padding: 0.75rem; border-radius: 0.5rem; max-width: 80%;">
                      <strong>Simek</strong>
                      <p class="mb-0 mt-1">Hello! I'm Simek, your AI assistant for ReefSpark. We're dedicated to predicting reef bleaching and providing unified, clean environmental data insights. I can help you with:</p>
                      <ul class="mb-0 mt-1">
                        <li>Analyzing environmental trends and patterns that affect reef health</li>
                        <li>Comparing statistics between locations to identify risk factors</li>
                        <li>Making predictions for future reef conditions</li>
                        <li>Explaining data insights for coral reef conservation</li>
                      </ul>
                      <p class="mb-0 mt-1">What would you like to know about reef protection?</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Input Area -->
              <div class="input-group">
                <input type="text" id="user-input" class="form-control" placeholder="Ask about reef health, environmental trends, predictions, or data insights..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary mb-0" type="button" onclick="sendMessage()" id="send-btn">
                  <i class="fas fa-paper-plane"></i> Send
                </button>
              </div>

              <!-- Example Questions -->
              <div class="mt-3">
                <small class="text-muted">Example questions:</small>
                <div class="mt-1">
                  <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="setQuestion('What are the top 5 locations with highest environmental stress indicators in 2023?')">Top risk areas 2023</button>
                  <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="setQuestion('Compare environmental trends between Italy and Sweden')">Compare countries</button>
                  <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="setQuestion('Predict environmental conditions for Rullsand beach in 2026 and 2027')">Predict future conditions</button>
                  <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="setQuestion('Which locations show the fastest environmental degradation?')">Degradation trends</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Core JS Files -->
  <script src="{{ url_for('static', filename='assets/js/core/popper.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/js/core/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/js/plugins/perfect-scrollbar.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/js/plugins/smooth-scrollbar.min.js') }}"></script>
  <script src="{{ url_for('static', filename='assets/js/soft-ui-dashboard.min.js') }}"></script>

  <script>
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function setQuestion(question) {
      userInput.value = question;
      userInput.focus();
    }

    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isUser ? 'user-message' : 'assistant-message'} mb-3`;
      
      if (isUser) {
        // Generate random avatar for user
        const randomSeed = Math.floor(Math.random() * 1000);
        messageDiv.innerHTML = `
          <div class="d-flex align-items-start justify-content-end">
            <div class="message-content" style="background: linear-gradient(310deg, #7928CA 0%, #FF0080 100%); color: white; padding: 0.75rem; border-radius: 0.5rem; max-width: 80%;">
              <strong>You</strong>
              <p class="mb-0 mt-1">${escapeHtml(content)}</p>
            </div>
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${randomSeed}" alt="You" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-left: 0.5rem;">
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="d-flex align-items-start">
            <img src="/static/media/AiPFP.png" alt="Simek" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 0.5rem;">
            <div class="message-content" style="background: white; padding: 0.75rem; border-radius: 0.5rem; max-width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <strong>Simek</strong>
              <div class="mb-0 mt-1">${formatResponse(content)}</div>
            </div>
          </div>
        `;
      }
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addLoadingMessage() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-message';
      loadingDiv.className = 'chat-message assistant-message mb-3';
      loadingDiv.innerHTML = `
        <div class="d-flex align-items-start">
          <img src="/static/media/AiPFP.png" alt="Simek" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 0.5rem;">
          <div class="message-content" style="background: white; padding: 0.75rem; border-radius: 0.5rem;">
            <strong>Simek</strong>
            <p class="mb-0 mt-1">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Thinking...
            </p>
          </div>
        </div>
      `;
      chatContainer.appendChild(loadingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeLoadingMessage() {
      const loadingMsg = document.getElementById('loading-message');
      if (loadingMsg) {
        loadingMsg.remove();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatResponse(text) {
      // Convert markdown-style formatting to HTML
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
      
      // Convert line breaks to <br>
      text = text.replace(/\n/g, '<br>');
      
      // Convert numbered lists
      text = text.replace(/(\d+)\.\s/g, '<br>$1. ');
      
      return text;
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      // Disable input while processing
      userInput.disabled = true;
      sendBtn.disabled = true;

      // Add user message to chat
      addMessage(message, true);
      userInput.value = '';

      // Show loading indicator
      addLoadingMessage();

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: message })
        });

        const data = await response.json();

        removeLoadingMessage();

        if (response.ok) {
          addMessage(data.response, false);
        } else {
          addMessage(`Error: ${data.error || 'Something went wrong'}`, false);
        }
      } catch (error) {
        removeLoadingMessage();
        addMessage(`Error: ${error.message}`, false);
      } finally {
        // Re-enable input
        userInput.disabled = false;
        sendBtn.disabled = false;
        userInput.focus();
      }
    }
  </script>
</body>

</html>
