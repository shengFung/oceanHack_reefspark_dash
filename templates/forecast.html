<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../static/assets/img/logospark.png">
  <link rel="icon" type="image/png" href="../static/assets/img/logospark.png">
  <title>Forecast - reefSpark</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <!-- CSS Files -->
  <link id="pagestyle" href="../static/assets/css/soft-ui-dashboard.css?v=1.1.0" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="../static/assets/js/plugins/chartjs.min.js"></script>
</head>

<body class="g-sidenav-show bg-gray-100">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 " id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href="/">
        <img src="../static/assets/img/logospark.png" class="navbar-brand-img h-100" alt="main_logo">
        <span class="ms-1 font-weight-bold">reefSpark</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link  " href="/">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg"><title>archive</title><path d="M5,10 L40,10 L40,30 L5,30 Z M10,15 L35,15 M10,20 L35,20" fill="#000000"/></svg>
            </div>
            <span class="nav-link-text ms-1">Historical Insights</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/litters">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg"><title>litter</title><rect x="8" y="18" width="6" height="12" fill="#000000"/><rect x="20" y="14" width="6" height="16" fill="#000000"/><rect x="32" y="10" width="6" height="20" fill="#000000"/></svg>
            </div>
            <span class="nav-link-text ms-1">Litters Information</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/simek">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <img src="../static/media/simekIcon.png" alt="Simek" style="width: 32px; height: 32px; object-fit: contain;">
            </div>
            <span class="nav-link-text ms-1">Simek</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/live-monitor">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg"><title>satellite</title><circle cx="22.5" cy="20" r="10" stroke="#000000" stroke-width="2" fill="none"/><line x1="10" y1="10" x2="35" y2="30" stroke="#000000" stroke-width="2"/></svg>
            </div>
            <span class="nav-link-text ms-1">Live Monitor</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/forecast">
            <div class="icon icon-shape icon-sm shadow border-radius-md bg-white text-center me-2 d-flex align-items-center justify-content-center">
              <svg width="12px" height="12px" viewBox="0 0 45 40" xmlns="http://www.w3.org/2000/svg"><title>forecast</title><polyline points="5,30 15,20 25,25 35,15 45,20" fill="none" stroke="#000000" stroke-width="2"/></svg>
            </div>
            <span class="nav-link-text ms-1">Forecast & Prediction</span>
          </a>
        </li>
      </ul>
    </div>
  </aside>

  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-dark" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Forecast</li>
          </ol>
          <h6 class="font-weight-bolder mb-0">Forecast</h6>
        </nav>
      </div>
    </nav>
    <!-- End Navbar -->

    <div class="container-fluid py-4">
      <div class="row">
        <!-- Region Selection -->
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="region">Select Region</label>
                    <select class="form-control" id="region" onchange="updateForecasts()">
                      <option value="global">Global</option>
                      <option value="tropics">Tropics</option>
                      <option value="arctic">Arctic</option>
                      <option value="antarctic">Antarctic</option>
                      <option value="indian">Indian Ocean</option>
                      <option value="pacific">Pacific Ocean</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="forecastPeriod">Forecast Period (Years)</label>
                    <select class="form-control" id="forecastPeriod" onchange="updateForecasts()">
                      <option value="5">5 Years</option>
                      <option value="10" selected>10 Years</option>
                      <option value="15">15 Years</option>
                      <option value="20">20 Years</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Temperature Forecast -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <h6>Temperature Forecast</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-thermometer-three-quarters text-warning"></i>
                <span class="font-weight-bold ms-1">Historical Surface Temperature Analysis (1800-1940)</span>
              </p>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="tempForecastChart" class="chart-canvas" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Oxygen Forecast -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <h6>Oxygen Level Forecast</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-wind text-info"></i>
                <span class="font-weight-bold ms-1">Historical Dissolved Oxygen Analysis (1800-1940)</span>
              </p>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="oxyForecastChart" class="chart-canvas" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- RSI Forecast -->
        <div class="col-lg-12 mb-4">
          <div class="card">
            <div class="card-header pb-0">
              <h6>Reef Stress Index (RSI) Forecast</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-exclamation-triangle text-danger"></i>
                <span class="font-weight-bold ms-1">Combined Stress Index Predictions</span>
              </p>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="rsiForecastChart" class="chart-canvas" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!--   Core JS Files   -->
  <script src="../static/assets/js/core/popper.min.js"></script>
  <script src="../static/assets/js/core/bootstrap.min.js"></script>
  <script src="../static/assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../static/assets/js/plugins/smooth-scrollbar.min.js"></script>

  <script>
    let tempChart, oxyChart, rsiChart;

    function initCharts() {
      // Temperature Chart
      const tempCtx = document.getElementById("tempForecastChart").getContext("2d");
      tempChart = new Chart(tempCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Historical",
              data: [],
              borderColor: "#3A416F",
              tension: 0.4,
              pointRadius: 2
            },
            {
              label: "Forecast",
              data: [],
              borderColor: "#cb0c9f",
              borderDash: [5, 5],
              tension: 0.4,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
            }
          },
          interaction: {
            intersect: false,
            mode: 'index',
          },
          scales: {
            y: {
              grid: {
                drawBorder: false,
                display: true,
                drawOnChartArea: true,
                drawTicks: false,
                borderDash: [5, 5]
              },
              ticks: {
                display: true,
                padding: 10,
                color: '#b2b9bf',
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: 'normal',
                  lineHeight: 2
                },
              }
            },
            x: {
              grid: {
                drawBorder: false,
                display: true,
                drawOnChartArea: true,
                drawTicks: false,
                borderDash: [5, 5]
              },
              ticks: {
                display: true,
                color: '#b2b9bf',
                padding: 10,
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: 'normal',
                  lineHeight: 2
                },
              }
            },
          },
        },
      });

      // Oxygen Chart
      const oxyCtx = document.getElementById("oxyForecastChart").getContext("2d");
      oxyChart = new Chart(oxyCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Historical",
              data: [],
              borderColor: "#17c1e8",
              tension: 0.4,
              pointRadius: 2
            },
            {
              label: "Forecast",
              data: [],
              borderColor: "#82d616",
              borderDash: [5, 5],
              tension: 0.4,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
            }
          },
          interaction: {
            intersect: false,
            mode: 'index',
          },
          scales: {
            y: {
              grid: {
                drawBorder: false,
                display: true,
                drawOnChartArea: true,
                drawTicks: false,
                borderDash: [5, 5]
              },
              ticks: {
                display: true,
                padding: 10,
                color: '#b2b9bf',
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: 'normal',
                  lineHeight: 2
                },
              }
            },
            x: {
              grid: {
                drawBorder: false,
                display: true,
                drawOnChartArea: true,
                drawTicks: false,
                borderDash: [5, 5]
              },
              ticks: {
                display: true,
                color: '#b2b9bf',
                padding: 10,
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: 'normal',
                  lineHeight: 2
                },
              }
            },
          },
        },
      });

      // RSI Chart
      const rsiCtx = document.getElementById("rsiForecastChart").getContext("2d");
      rsiChart = new Chart(rsiCtx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Historical RSI",
              data: [],
              borderColor: "#ea0606",
              tension: 0.4,
              pointRadius: 2
            },
            {
              label: "Forecast RSI",
              data: [],
              borderColor: "#fb6340",
              borderDash: [5, 5],
              tension: 0.4,
              pointRadius: 2
            },
            {
              label: "Thermal Stress",
              data: [],
              borderColor: "#ffcf00",
              tension: 0.4,
              pointRadius: 2
            },
            {
              label: "Oxygen Stress",
              data: [],
              borderColor: "#3A416F",
              tension: 0.4,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
            }
          },
          interaction: {
            intersect: false,
            mode: 'index',
          },
          scales: {
            y: {
              grid: {
                drawBorder: false,
                display: true,
                drawOnChartArea: true,
                drawTicks: false,
                borderDash: [5, 5]
              },
              ticks: {
                display: true,
                padding: 10,
                color: '#b2b9bf',
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: 'normal',
                  lineHeight: 2
                },
              }
            },
            x: {
              grid: {
                drawBorder: false,
                display: true,
                drawOnChartArea: true,
                drawTicks: false,
                borderDash: [5, 5]
              },
              ticks: {
                display: true,
                color: '#b2b9bf',
                padding: 10,
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: 'normal',
                  lineHeight: 2
                },
              }
            },
          },
        },
      });
    }

    async function updateForecasts() {
      const region = document.getElementById('region').value;
      const forecastYears = parseInt(document.getElementById('forecastPeriod').value);

      console.log(`Updating forecasts for region: ${region}, forecast years: ${forecastYears}`);

      try {
        // Fetch historical data and generate forecasts (including RSI forecast)
        const [trendsResponse, rsiHistResponse, rsiForecastResponse] = await Promise.all([
          fetch(`/api/trends?region=${region}`),
          fetch(`/api/reef_stress?region=${region}`),
          fetch(`/api/forecast/rsi?region=${region}&forecast_years=${forecastYears}`)
        ]);

        const trendsData = await trendsResponse.json();
        const rsiHist = await rsiHistResponse.json();
        const rsiFc = await rsiForecastResponse.json();
        
        console.log('Trends data received:', trendsData);
        console.log('RSI historical data received:', rsiHist);
        console.log('RSI forecast data received:', rsiFc);

        // Update temperature forecast
        const tempData = trendsData.temp_data;
        const tempLabels = trendsData.labels;
        const tempForecast = generateForecast(tempData, forecastYears);
        const futureYears = generateFutureYears(tempLabels[tempLabels.length - 1], forecastYears);
        
        // Create a continuous line by overlapping one point
        const lastHistoricalValue = tempData[tempData.length - 1];
        const historicalData = [...tempData, ...Array(forecastYears).fill(null)];
        const forecastData = Array(tempLabels.length - 1).fill(null).concat([lastHistoricalValue, ...tempForecast]);
        
        // Clear existing data and set new data
        tempChart.data.labels = [...tempLabels, ...futureYears];
        tempChart.data.datasets[0].data = historicalData;
        tempChart.data.datasets[1].data = forecastData;
        console.log(`Temperature chart updated: ${tempLabels.length} historical points, ${forecastYears} forecast points`);
        tempChart.update('none'); // Update without animation for smoother transition

  // Update oxygen forecast (create continuous forecast that connects to last historical point)
  const oxyData = trendsData.oxy_data;
  const oxyLabels = trendsData.labels2;
  const oxyForecast = generateForecast(oxyData, forecastYears);
  const oxyLast = oxyData[oxyData.length - 1];
  const oxyHistData = [...oxyData, ...Array(forecastYears).fill(null)];
  const oxyFcData = Array(oxyData.length - 1).fill(null).concat([oxyLast, ...oxyForecast]);

  oxyChart.data.labels = [...oxyLabels, ...futureYears];
  oxyChart.data.datasets[0].data = oxyHistData;
  oxyChart.data.datasets[1].data = oxyFcData;
  console.log(`Oxygen chart updated: ${oxyLabels.length} historical points, ${forecastYears} forecast points`);
  oxyChart.update('none');

  // Update RSI forecast: use backend forecast and connect smoothly to historical RSI
  const rsiValues = rsiHist.RSI;
  const rsiLabels = rsiHist.years;
  const rsiFuture = rsiFc.forecast.RSI || rsiFc.forecast.RSI; // fallback
  const rsiTsiHist = rsiHist.TSI;
  const rsiOsiHist = rsiHist.OSI;
  const rsiLast = rsiValues[rsiValues.length - 1];
  const rsiFutureYears = generateFutureYears(rsiLabels[rsiLabels.length - 1], forecastYears);

  const rsiHistData = [...rsiValues, ...Array(forecastYears).fill(null)];
  const rsiFcData = Array(rsiValues.length - 1).fill(null).concat([rsiLast, ...rsiFuture]);

  rsiChart.data.labels = [...rsiLabels, ...rsiFutureYears];
  rsiChart.data.datasets[0].data = rsiHistData;
  rsiChart.data.datasets[1].data = rsiFcData;
  rsiChart.data.datasets[2].data = [...rsiTsiHist, ...Array(forecastYears).fill(null)];
  rsiChart.data.datasets[3].data = [...rsiOsiHist, ...Array(forecastYears).fill(null)];
  console.log(`RSI chart updated: ${rsiLabels.length} historical points, ${forecastYears} forecast points`);
  rsiChart.update('none');

      } catch (error) {
        console.error('Error updating forecasts:', error);
      }
    }

    function generateForecast(historicalData, periods) {
      // Simple linear regression for forecasting
      const n = historicalData.length;
      const x = Array.from({length: n}, (_, i) => i);
      const y = historicalData;
      
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      
      for(let i = 0; i < n; i++) {
        sumX += x[i];
        sumY += y[i];
        sumXY += x[i] * y[i];
        sumX2 += x[i] * x[i];
      }
      
      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      
      // Generate forecast values
      return Array.from({length: periods}, (_, i) => {
        const nextX = n + i;
        return slope * nextX + intercept;
      });
    }

    function generateFutureYears(lastYear, periods) {
      return Array.from({length: periods}, (_, i) => lastYear + i + 1);
    }

    // Initialize charts on load
    document.addEventListener("DOMContentLoaded", function() {
      initCharts();
      updateForecasts();
    });

    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>

  <!-- Floating Simek Chatbot Button -->
  <a href="/simek" id="simek-float-btn" style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: transparent; box-shadow: 0 4px 20px rgba(121, 40, 202, 0.4); display: flex; align-items: center; justify-content: center; text-decoration: none; z-index: 1000; transition: all 0.3s ease; animation: pulse 2s infinite;">
    <img src="/static/media/AiPFPWh.png" alt="Simek AI" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
  </a>
  
  <div id="simek-tooltip" style="position: fixed; bottom: 100px; right: 30px; background: white; padding: 12px 16px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 999; max-width: 200px;">
    <strong style="color: #7928CA;">Simek AI</strong>
    <p style="margin: 5px  0 0 0; font-size: 13px; color: #666;">Your AI assistant for reef health insights. Ask me about environmental data and predictions!</p>
  </div>

  <style>
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 20px rgba(121, 40, 202, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 6px 25px rgba(121, 40, 202, 0.6);
      }
    }

    #simek-float-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(121, 40, 202, 0.6);
    }

    #simek-float-btn:hover + #simek-tooltip {
      opacity: 1;
      visibility: visible;
    }
  </style>

  <script>
    // Show tooltip on hover
    const floatBtn = document.getElementById('simek-float-btn');
    const tooltip = document.getElementById('simek-tooltip');
    
    floatBtn.addEventListener('mouseenter', () => {
      tooltip.style.opacity = '1';
      tooltip.style.visibility = 'visible';
    });
    
    floatBtn.addEventListener('mouseleave', () => {
      tooltip.style.opacity = '0';
      tooltip.style.visibility = 'hidden';
    });
  </script>

</body>

</html>